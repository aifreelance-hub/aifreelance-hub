<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aurum Task Desk — 私人AI写作台</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #050816;
      color: #f7f5f0;
      line-height: 1.6;
    }
    a { color: inherit; text-decoration: none; }

    .container {
      max-width: 1180px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 顶部导航 */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(14px);
      background: rgba(5, 8, 22, 0.95);
      border-bottom: 1px solid rgba(204, 188, 119, 0.12);
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-left {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #f5f2e6;
    }
    .nav-right a {
      margin-left: 22px;
      font-size: 14px;
      opacity: 0.86;
    }
    .nav-right a:hover {
      opacity: 1;
      color: #f0d37a;
    }

    /* 主体布局 */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 24px;
      margin-top: 30px;
      align-items: flex-start;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: radial-gradient(circle at top left, #181923, #050816);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 18px 18px 20px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .card-sub {
      font-size: 13px;
      color: #b7b3aa;
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #f5f2ea;
    }
    textarea, select, input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(8, 10, 25, 0.9);
      color: #f7f5f0;
      font-family: inherit;
      font-size: 13px;
    }
    textarea { min-height: 160px; resize: vertical; }

    .inline {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .inline .field { flex: 1; }

    .hint {
      font-size: 12px;
      color: #8f8b82;
      margin-top: 4px;
    }

    .btn-primary {
      padding: 9px 18px;
      border-radius: 999px;
      border: 1px solid #f0d37a;
      background: linear-gradient(135deg, #f0d37a, #cba84f);
      color: #18120a;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .btn-secondary {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(240, 211, 122, 0.5);
      background: transparent;
      font-size: 12px;
      color: #f0d37a;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn-secondary:hover {
      background: rgba(240, 211, 122, 0.08);
    }
    .btn-pay {
      padding: 9px 16px;
      border-radius: 999px;
      border: 1px solid #35c66a;
      background: linear-gradient(135deg, #35c66a, #1c8a47);
      color: #04120a;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn-pay:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status-text {
      font-size: 12px;
      color: #a7a39b;
      margin-top: 6px;
    }

    /* 结果区域 */
    .result-box {
      position: relative;
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      background: radial-gradient(circle at top, #161827, #050816);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 420px;
      overflow-y: auto;
    }
    .result-empty {
      font-size: 13px;
      color: #9c978d;
    }

    /* 预览遮罩 */
    .preview-mask {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 70px;
      background: linear-gradient(to bottom, rgba(5,8,22,0) 0%, rgba(5,8,22,0.92) 70%);
      pointer-events: none;
    }
    .preview-tag {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(240, 211, 122, 0.7);
      color: #f0d37a;
    }

    .pay-note {
      font-size: 12px;
      color: #c1bcaf;
      margin-top: 6px;
    }
    .pay-note strong { color: #f0d37a; }

    .footer {
      margin-top: 60px;
      padding: 24px 0 32px;
      border-top: 1px solid rgba(204, 188, 119, 0.22);
      font-size: 13px;
      color: #a59f94;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- 顶部导航 -->
  <header class="navbar">
    <div class="nav-left">AURUM TASK DESK</div>
    <nav class="nav-right">
      <a href="index.html">首页</a>
      <a href="tasks.html">任务市场</a>
      <a href="about.html">关于</a>
      <a href="pricing.html">我们的定价</a>
      <a href="contact.html">联系我们</a>
    </nav>
  </header>

  <main class="container">
    <section class="layout">
      <!-- 左侧：客户输入 -->
      <article class="card">
        <h2 class="card-title">AI 桌面台（私有）</h2>
        <p class="card-sub">
          粘贴客户的备注或大致想法。桌面台会将其转换为清晰、适合美国 / 欧洲中老年专业人士阅读的文本。
          你可以先预览，再决定是否解锁完整稿件。
        </p>

        <div class="field">
          <label for="clientNote">客户任务 / 备注</label>
          <textarea id="clientNote" placeholder="例如：Please draft a debt collection agreement for me."></textarea>
          <div class="hint">可以是中英文混合、口语化描述，AI 会帮你整理成清晰稿件。</div>
        </div>

        <div class="inline">
          <div class="field">
            <label for="tone">语气</label>
            <select id="tone">
              <option value="calm">平静、尊重</option>
              <option value="professional">专业、正式</option>
              <option value="warm">温和、关心</option>
              <option value="firm">坚定但礼貌</option>
            </select>
          </div>
          <div class="field">
            <label for="language">语言</label>
            <select id="language">
              <option value="english">英文</option>
              <option value="chinese">中文</option>
              <option value="bilingual">中英文双语</option>
            </select>
          </div>
        </div>

        <div style="margin-top: 16px;">
          <button type="button" class="btn-primary" id="generateBtn">生成草稿（预览）</button>
          <button type="button" class="btn-secondary" id="exampleBtn">填入示例</button>
          <div class="status-text" id="statusText"></div>
        </div>
      </article>

      <!-- 右侧：AI 结果 + 收费解锁 -->
      <aside class="card">
        <h2 class="card-title">桌面 AI 智能草稿</h2>
        <p class="card-sub">
          下面首先展示 <strong>预览部分</strong>，方便你判断是否合适。完整稿件和复制功能在付款后解锁。
        </p>

        <div id="resultBox" class="result-box">
          <div class="result-empty">
            尚未生成草稿。请在左侧粘贴客户备注，点击「生成草稿（预览）」。
          </div>
        </div>

        <div style="margin-top: 12px;">
          <button type="button" class="btn-pay" id="unlockBtn" disabled>解锁完整稿件（$9.99）</button>
          <button type="button" class="btn-secondary" id="copyBtn" disabled>复制完整稿件</button>
        </div>
        <div class="pay-note" id="payNote">
          预览为全文的部分片段。<br>
          支付后将自动返回本页面并解锁本次稿件的 <strong>完整内容 + 复制按钮</strong>。
        </div>
      </aside>
    </section>

    <footer class="footer">
      © 2025 Aurum Task Desk — 私人 AI 任务协调桌面台
    </footer>
  </main>

  <script>
    // ✅ 你的 Cloudflare Worker AI 接口（已确认）
    const WORKER_API_URL = "https://aurum-task-worker.sophieinbg.workers.dev/api/generate";

    // ✅ Stripe 支付链接（需要你替换成自己的 Payment Link）
    // 建议在 Stripe 创建一个一次性付款链接：
    // 价格例如 9.99 USD，成功跳转地址设置为：
    // https://aifreelance-hub.github.io/aifreelance-hub/index.html?paid=1
    const STRIPE_PAYMENT_URL = "https://STRIPE_PAYMENT_URL_HERE";

    const clientNoteEl = document.getElementById("clientNote");
    const toneEl = document.getElementById("tone");
    const languageEl = document.getElementById("language");
    const generateBtn = document.getElementById("generateBtn");
    const exampleBtn = document.getElementById("exampleBtn");
    const statusText = document.getElementById("statusText");
    const resultBox = document.getElementById("resultBox");
    const unlockBtn = document.getElementById("unlockBtn");
    const copyBtn = document.getElementById("copyBtn");
    const payNote = document.getElementById("payNote");

    // 用于保存当前完整稿件
    let currentFullDraft = "";
    let previewMode = true; // 是否处于预览模式

    // 示例填入
    exampleBtn.addEventListener("click", () => {
      clientNoteEl.value = "Please draft a debt collection agreement for me. " +
        "The debtor has delayed payment for 8 months. I want the tone to be serious but respectful, " +
        "and I would like it to be suitable for an older US businessman.";
      toneEl.value = "professional";
      languageEl.value = "bilingual";
    });

    // 生成草稿（预览）
    generateBtn.addEventListener("click", async () => {
      const note = clientNoteEl.value.trim();
      const tone = toneEl.value;
      const lang = languageEl.value;

      if (!note) {
        alert("请先粘贴或输入客户的任务 / 备注。");
        return;
      }

      generateBtn.disabled = true;
      generateBtn.textContent = "生成中...";
      statusText.textContent = "正在向 Aurum 桌面 AI 请求草稿，请稍候...";
      resultBox.innerHTML = "";

      // 每次生成新稿件时，锁定按钮，避免旧的解锁状态污染
      currentFullDraft = "";
      previewMode = true;
      unlockBtn.disabled = true;
      copyBtn.disabled = true;
      payNote.innerHTML =
        '预览为全文的部分片段。<br>支付后将自动返回本页面并解锁本次稿件的 <strong>完整内容 + 复制按钮</strong>。';

      try {
        let prompt = "You are Aurum Task Desk AI. You help older US and EU men (50+), " +
          "including veterans, truck drivers, engineers and small business owners, " +
          "to write calm, clear and respectful texts.\n\n";
        prompt += "Client note: " + note + "\n";
        prompt += "Tone: " + tone + "\n";
        prompt += "Language: " + lang + " (if bilingual, give English first then Chinese).\n\n";
        prompt += "Write a complete draft that this client can directly copy and send. " +
          "Avoid overly fancy words. Sound mature and sincere.\n";

        const res = await fetch(WORKER_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        const data = await res.json();

        if (!res.ok || !data.ok) {
          const msg = (data && data.error) ? data.error : ("HTTP " + res.status);
          throw new Error(msg);
        }

        const fullText = data.text || "No content returned from Aurum AI.";
        currentFullDraft = fullText;

        const previewText = createPreview(fullText);

        renderResult(previewText, true);
        previewMode = true;

        // 允许用户解锁（付款）当前稿件
        unlockBtn.disabled = false;
        statusText.textContent = "预览已生成。如满意方向，可以解锁完整稿件。";
      } catch (err) {
        console.error(err);
        resultBox.innerHTML =
          '<div class="result-empty">生成草稿时出现问题：' +
          (err.message || String(err)) +
          "</div>";
        statusText.textContent = "";
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = "生成草稿（预览）";
      }
    });

    // 生成预览内容：取前 30% 左右，至少保留几段
    function createPreview(text) {
      if (!text) return "";

      const maxChars = 900; // 预览最大字数（可自己调节）
      if (text.length <= maxChars) return text;

      // 尽量在换行处截断更自然
      let cut = maxChars;
      const nextBreak = text.indexOf("\n", maxChars);
      if (nextBreak > 0 && nextBreak - maxChars < 120) {
        cut = nextBreak;
      }
      return text.slice(0, cut) + "\n\n[……以下为预览截断，完整稿件解锁后可见……]";
    }

    // 渲染结果（预览 / 完整）
    function renderResult(text, isPreview) {
      resultBox.innerHTML = "";
      const wrapper = document.createElement("div");
      wrapper.textContent = text;
      resultBox.appendChild(wrapper);

      if (isPreview) {
        // 预览遮罩
        const mask = document.createElement("div");
        mask.className = "preview-mask";
        resultBox.appendChild(mask);

        const tag = document.createElement("div");
        tag.className = "preview-tag";
        tag.textContent = "预览片段 · 完整稿件需解锁";
        resultBox.appendChild(tag);

        copyBtn.disabled = true;
      } else {
        copyBtn.disabled = false;
      }
    }

    // 解锁完整稿件（付款）
    unlockBtn.addEventListener("click", () => {
      if (!currentFullDraft) {
        alert("请先生成一份草稿。");
        return;
      }
      if (!STRIPE_PAYMENT_URL || STRIPE_PAYMENT_URL.includes("STRIPE_PAYMENT_URL_HERE")) {
        alert("还没有配置 Stripe 支付链接。请先在代码中替换 STRIPE_PAYMENT_URL。");
        return;
      }

      // 把当前完整稿件暂存到 localStorage
      localStorage.setItem("aurum_latest_draft", currentFullDraft);

      // 跳转到 Stripe 支付页面
      window.location.href = STRIPE_PAYMENT_URL;
    });

    // 复制完整稿件
    copyBtn.addEventListener("click", async () => {
      if (!currentFullDraft) {
        alert("暂无可复制的稿件。");
        return;
      }
      try {
        await navigator.clipboard.writeText(currentFullDraft);
        statusText.textContent = "完整稿件已复制到剪贴板。";
      } catch (e) {
        alert("复制失败，请手动选择文本复制。");
      }
    });

    // 页面加载时，检测是否是支付成功返回
    (function initUnlockFromReturn() {
      const params = new URLSearchParams(window.location.search);
      const paid = params.get("paid");

      if (paid === "1") {
        const saved = localStorage.getItem("aurum_latest_draft");
        if (saved) {
          currentFullDraft = saved;
          previewMode = false;
          renderResult(currentFullDraft, false);
          unlockBtn.disabled = true;
          copyBtn.disabled = false;
          payNote.innerHTML = "<strong>本次稿件已解锁完整内容。</strong><br>你可以复制、保存或发送给客户。";
          statusText.textContent = "付款成功，完整稿件已解锁。";
        } else {
          // 没有缓存草稿，就提示用户重新生成
          resultBox.innerHTML =
            '<div class="result-empty">已从支付页面返回，但未找到本次稿件缓存。请重新生成一次草稿。</div>';
        }
      }
    })();
  </script>
</body>
</html>
