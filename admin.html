<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aurum Task Desk â€” Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" />
  <style>
    :root {
      --bg-deep: #020617;
      --bg-panel: #020617;
      --bg-card: rgba(15, 23, 42, 0.96);
      --bg-card-soft: rgba(15, 23, 42, 0.85);
      --gold: #facc15;
      --gold-soft: #fde68a;
      --gold-deep: #ca8a04;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.3);
      --danger: #f97373;
      --shadow-soft: 0 24px 80px rgba(15, 23, 42, 0.95);
      --radius-xl: 18px;
      --radius-2xl: 24px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1220 0, #020617 55%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    /* ===== å·¦ä¾§å¯¼èˆªæ  ===== */
    .sidebar {
      width: 260px;
      background: radial-gradient(circle at top left, #0f172a 0, #020617 55%);
      border-right: 1px solid rgba(148, 163, 184, 0.25);
      padding: 22px 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(
        from 210deg,
        #facc15,
        #f97316,
        #22c55e,
        #38bdf8,
        #facc15
      );
      padding: 3px;
      box-shadow:
        0 0 15px rgba(250, 204, 21, 0.6),
        0 0 40px rgba(30, 64, 175, 0.8);
    }

    .brand-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: radial-gradient(circle at 30% 0, #1e293b 0, #020617 56%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.08em;
      color: var(--gold-soft);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--gold-soft);
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .nav-section-title {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
      margin-top: 10px;
      margin-bottom: 8px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s ease-out;
    }

    .nav-item.active {
      background: radial-gradient(circle at top left, #facc15 0, #f59e0b 35%, #854d0e 100%);
      color: #020617;
      border-color: rgba(250, 204, 21, 0.7);
      box-shadow:
        0 0 18px rgba(250, 204, 21, 0.45),
        0 0 45px rgba(15, 23, 42, 1);
      font-weight: 600;
    }

    .nav-item:hover:not(.active) {
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.5);
    }

    .nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #facc15, #f97316);
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.6);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      border-top: 1px solid rgba(51, 65, 85, 0.9);
      padding-top: 10px;
    }

    .sidebar-footer span {
      display: block;
      margin-bottom: 2px;
    }

    /* ===== å³ä¾§ä¸»å†…å®¹åŒºåŸŸ ===== */
    .main {
      flex: 1;
      padding: 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      max-width: calc(100vw - 260px);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .top-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill-live {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: linear-gradient(
        120deg,
        rgba(22, 163, 74, 0.25),
        rgba(21, 128, 61, 0.4)
      );
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge-env {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), #020617);
    }

    .btn-logout {
      font-size: 12px;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
    }

    .btn-logout:hover {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.7);
    }

    /* ===== æ¦‚è§ˆå¡ç‰‡åŒº ===== */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }

    .card {
      border-radius: var(--radius-2xl);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      padding: 14px 16px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -80px;
      opacity: 0.05;
      background: radial-gradient(circle at top left, #facc15, transparent 60%);
      pointer-events: none;
    }

    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .card-value {
      font-size: 22px;
      font-weight: 600;
      color: var(--gold-soft);
    }

    .card-desc {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ===== ç”¨æˆ·è¡¨æ ¼å¡ç‰‡ ===== */
    .panel {
      margin-top: 4px;
      border-radius: var(--radius-2xl);
      background: var(--bg-card-soft);
      border: 1px solid var(--border-subtle);
      padding: 14px 16px 10px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 260px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 4px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #facc15, #f97316);
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.7);
    }

    .panel-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .search-box input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-main);
      font-size: 12px;
      width: 150px;
    }

    .search-box input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }

    .badge-count {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
    }

    .table-wrapper {
      border-radius: var(--radius-xl);
      border: 1px solid rgba(30, 64, 175, 0.6);
      overflow: hidden;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), #020617);
      max-height: 360px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: linear-gradient(
        120deg,
        rgba(30, 64, 175, 0.9),
        rgba(15, 23, 42, 0.98)
      );
    }

    thead th {
      text-align: left;
      padding: 8px 10px;
      font-weight: 500;
      color: rgba(226, 232, 240, 0.95);
      border-bottom: 1px solid rgba(30, 64, 175, 0.9);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.8);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.93);
    }

    tbody td {
      padding: 7px 10px;
      color: rgba(209, 213, 219, 0.98);
      border-bottom: 1px solid rgba(30, 64, 175, 0.5);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 260px;
    }

    .email-cell {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 11px;
    }

    .empty-row td {
      text-align: center;
      padding: 18px 10px;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* ===== ç™»å½•é®ç½©å±‚ ===== */
    .login-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(20px);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), #000);
      z-index: 20;
    }

    .login-card {
      width: 360px;
      border-radius: 24px;
      padding: 20px 24px 18px;
      background: radial-gradient(circle at top, #020617, #020617);
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow:
        0 32px 120px rgba(0, 0, 0, 1),
        0 0 40px rgba(250, 204, 21, 0.15);
      position: relative;
      overflow: hidden;
    }

    .login-card::before {
      content: "";
      position: absolute;
      inset: -40px;
      background: radial-gradient(circle at top, rgba(250, 204, 21, 0.28), transparent 65%);
      opacity: 0.6;
      pointer-events: none;
    }

    .login-header {
      position: relative;
      z-index: 1;
      margin-bottom: 10px;
    }

    .login-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .login-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.8);
      color: var(--gold-soft);
      background: rgba(17, 24, 39, 0.9);
    }

    .login-subtitle {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .login-form {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .field-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .field-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }

    .field-input:focus {
      border-color: rgba(250, 204, 21, 0.9);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.4);
    }

    .btn-primary {
      margin-top: 4px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: radial-gradient(circle at 30% 0, #facc15, #f59e0b);
      color: #020617;
      box-shadow:
        0 14px 35px rgba(250, 204, 21, 0.65),
        0 0 20px rgba(30, 64, 175, 0.8);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
        filter 0.1s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow:
        0 18px 45px rgba(250, 204, 21, 0.8),
        0 0 26px rgba(30, 64, 175, 0.9);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow:
        0 10px 26px rgba(250, 204, 21, 0.6),
        0 0 18px rgba(30, 64, 175, 0.9);
    }

    .login-error {
      margin-top: 4px;
      font-size: 11px;
      color: #fecaca;
      min-height: 16px;
    }

    .login-footnote {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
    }

    /* å°å±å¤„ç† */
    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      .main {
        max-width: 100vw;
        padding: 16px 12px;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ç™»å½•é®ç½©å±‚ -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-card">
      <div class="login-header">
        <div class="login-title">
          Aurum Admin
          <span class="login-badge">Internal Desk</span>
        </div>
        <div class="login-subtitle">
          è¾“å…¥ä½ çš„ <strong>ç®¡ç†å‘˜å¯†ç </strong> æ¥æŸ¥çœ‹æ³¨å†Œç”¨æˆ·å’Œæ¡Œé¢æ´»åŠ¨ã€‚
        </div>
      </div>
      <form class="login-form" id="loginForm">
        <div>
          <div class="field-label">Admin password</div>
          <input
            type="password"
            class="field-input"
            id="adminPassword"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            required
          />
        </div>
        <button class="btn-primary" type="submit" id="loginBtn">
          è¿›å…¥ Aurum Task Desk åå°
        </button>
        <div class="login-error" id="loginError"></div>
        <div class="login-footnote">
          æç¤ºï¼šå¯†ç åœ¨ Cloudflare Worker çš„ <code>ADMIN_PASSWORD</code> é‡Œè®¾ç½®ã€‚
        </div>
      </form>
    </div>
  </div>

  <!-- å·¦ä¾§å¯¼èˆª -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <div class="brand-inner">A</div>
      </div>
      <div class="brand-text">
        <div class="brand-title">Aurum Task Desk</div>
        <div class="brand-subtitle">Founder Desk â€¢ Private Admin</div>
      </div>
    </div>

    <div>
      <div class="nav-section-title">OVERVIEW</div>
      <div class="nav">
        <div class="nav-item active">
          <div class="nav-dot"></div>
          User Overview
        </div>
        <div class="nav-item" style="opacity: 0.4; cursor: default;">
          <div class="nav-dot"></div>
          Tasks (coming soon)
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <span>Only for you / internal use.</span>
      <span>Visitors stats â†’ Google Analytics.</span>
    </div>
  </aside>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <main class="main">
    <header class="top-bar">
      <div class="top-left">
        <div class="page-title">
          Desk Users
          <span class="pill-live">
            â— LIVE
            <span style="opacity: 0.7;">Private Admin</span>
          </span>
        </div>
        <div class="page-subtitle">
          æŸ¥çœ‹è°æ³¨å†Œäº† Aurum Task Deskï¼Œä»¥åŠæ¯æ—¥æ³¨å†ŒèŠ‚å¥ã€‚
        </div>
      </div>
      <div class="top-right">
        <div class="badge-env">
          <span>Environment</span>
          <strong>Production</strong>
        </div>
        <button class="btn-logout" id="logoutBtn">
          â‹ Logout
        </button>
      </div>
    </header>

    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <section class="grid">
      <div class="card">
        <div class="card-title">Total Registered Users</div>
        <div class="card-value" id="totalUsers">â€“</div>
        <div class="card-desc">ä»ä½ ä¸Šçº¿ Aurum Task Desk åˆ°ç°åœ¨çš„æ€»æ³¨å†Œæ•°ã€‚</div>
      </div>
      <div class="card">
        <div class="card-title">Last 7 Days</div>
        <div class="card-value" id="last7Days">â€“</div>
        <div class="card-desc">æœ€è¿‘ 7 å¤©æ–°æ³¨å†Œçš„ç”¨æˆ·æ•°ï¼Œç²—ç•¥çœ‹ä¸€ä¸‹èŠ‚å¥ã€‚</div>
      </div>
      <div class="card">
        <div class="card-title">Newest User</div>
        <div class="card-value" id="newestUser">â€“</div>
        <div class="card-desc">æœ€è¿‘ä¸€ä½æ³¨å†Œçš„ç”¨æˆ·é‚®ç®±ï¼ˆé®æŒ¡éƒ¨åˆ†ä¿¡æ¯ï¼Œæ–¹ä¾¿ä½ è¯†åˆ«ï¼‰ã€‚</div>
      </div>
    </section>

    <!-- ç”¨æˆ·è¡¨æ ¼ -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">
            <span class="dot"></span> Registered Desk Users
          </div>
          <div class="panel-subtitle">
            æ•°æ®æ¥è‡ª Cloudflare D1 ä¸­çš„ <code>users</code> è¡¨ã€‚
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="search-box">
            <span style="font-size: 12px;">ğŸ”</span>
            <input
              type="text"
              id="searchInput"
              placeholder="Search email..."
            />
          </div>
          <div class="badge-count">
            <span id="visibleCount">0</span> / <span id="totalCount">0</span> users
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width: 38%;">Email</th>
              <th style="width: 30%;">Registered At</th>
              <th style="width: 20%;">User ID</th>
              <th style="width: 12%;">Notes</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <tr class="empty-row">
              <td colspan="4">åŠ è½½ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ç®€å•ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè¯·ç¡®ä¿ admin.html å’Œ Worker åœ¨åŒä¸€åŸŸå
    const API_BASE = "";

    let allUsers = [];

    function maskEmail(email) {
      if (!email || typeof email !== "string") return "";
      const [name, domain] = email.split("@");
      if (!domain) return email;
      if (name.length <= 2) {
        return name[0] + "***@" + domain;
      }
      return name.slice(0, 2) + "***@" + domain;
    }

    function formatDateTime(str) {
      if (!str) return "";
      const d = new Date(str);
      if (Number.isNaN(d.getTime())) return str;
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hour = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${year}-${month}-${day} ${hour}:${min}`;
    }

    function renderCards(users) {
      const total = users.length;
      document.getElementById("totalUsers").textContent = total || "0";

      // æœ€è¿‘ 7 å¤©
      const now = Date.now();
      const sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000;
      const count7 = users.filter((u) => {
        if (!u.created_at) return false;
        const t = new Date(u.created_at).getTime();
        if (Number.isNaN(t)) return false;
        return t >= sevenDaysAgo;
      }).length;
      document.getElementById("last7Days").textContent = count7 || "0";

      // æœ€æ–°ç”¨æˆ·
      if (users.length > 0) {
        const newest = users[0];
        document.getElementById("newestUser").textContent =
          maskEmail(newest.email || "");
      } else {
        document.getElementById("newestUser").textContent = "â€“";
      }
    }

    function renderTable(users) {
      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";

      if (!users.length) {
        const tr = document.createElement("tr");
        tr.className = "empty-row";
        const td = document.createElement("td");
        td.colSpan = 4;
        td.textContent = "æš‚æ— æ³¨å†Œç”¨æˆ·ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      users.forEach((u) => {
        const tr = document.createElement("tr");

        const tdEmail = document.createElement("td");
        tdEmail.className = "email-cell";
        tdEmail.textContent = u.email || "";

        const tdTime = document.createElement("td");
        tdTime.textContent = formatDateTime(u.created_at);

        const tdId = document.createElement("td");
        tdId.textContent = u.id || "";

        const tdNote = document.createElement("td");
        tdNote.textContent = "Desk user";

        tr.appendChild(tdEmail);
        tr.appendChild(tdTime);
        tr.appendChild(tdId);
        tr.appendChild(tdNote);

        tbody.appendChild(tr);
      });
    }

    function applySearch() {
      const q = document
        .getElementById("searchInput")
        .value.trim()
        .toLowerCase();
      let filtered = allUsers;
      if (q) {
        filtered = allUsers.filter((u) =>
          (u.email || "").toLowerCase().includes(q)
        );
      }
      document.getElementById("visibleCount").textContent = filtered.length;
      document.getElementById("totalCount").textContent = allUsers.length;
      renderTable(filtered);
    }

    async function loadUsers() {
      try {
        const res = await fetch(API_BASE + "/admin/users", {
          method: "GET",
        });

        if (res.status === 401) {
          // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æ¡†
          document.getElementById("loginOverlay").style.display = "flex";
          return;
        }

        if (!res.ok) {
          throw new Error("åŠ è½½å¤±è´¥");
        }

        const data = await res.json();
        allUsers = data.users || [];
        renderCards(allUsers);
        document.getElementById("totalCount").textContent = allUsers.length;
        applySearch();

        // å·²ç™»å½•ï¼ŒæŠŠç™»å½•å±‚éšè—
        document.getElementById("loginOverlay").style.display = "none";
      } catch (err) {
        console.error(err);
        const tbody = document.getElementById("userTableBody");
        tbody.innerHTML = "";
        const tr = document.createElement("tr");
        tr.className = "empty-row";
        const td = document.createElement("td");
        td.colSpan = 4;
        td.textContent = "åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    async function login(password) {
      const btn = document.getElementById("loginBtn");
      const errBox = document.getElementById("loginError");
      btn.disabled = true;
      btn.textContent = "æ­£åœ¨éªŒè¯...";
      errBox.textContent = "";
      try {
        const res = await fetch(API_BASE + "/admin/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ password }),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || "ç™»å½•å¤±è´¥");
        }

        // ç™»å½•æˆåŠŸåï¼ŒåŠ è½½ç”¨æˆ·æ•°æ®
        await loadUsers();
      } catch (err) {
        errBox.textContent = err.message || "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç ã€‚";
      } finally {
        btn.disabled = false;
        btn.textContent = "è¿›å…¥ Aurum Task Desk åå°";
      }
    }

    async function logout() {
      try {
        await fetch(API_BASE + "/admin/logout", {
          method: "POST",
        });
      } catch (e) {
        console.error(e);
      } finally {
        // å›åˆ°ç™»å½•ç”»é¢
        document.getElementById("loginOverlay").style.display = "flex";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // åˆå§‹åŒ–åŠ è½½ä¸€æ¬¡æ•°æ®ï¼ˆå¦‚æœæœ‰ cookie å°±ç›´æ¥è¿›ï¼‰
      loadUsers();

      document
        .getElementById("loginForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const pwd = document.getElementById("adminPassword").value;
          if (!pwd) return;
          login(pwd);
        });

      document
        .getElementById("logoutBtn")
        .addEventListener("click", logout);

      document
        .getElementById("searchInput")
        .addEventListener("input", applySearch);
    });
  </script>
</body>
</html>
