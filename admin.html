<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Aurum Admin — Pro Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #000 100%);
      color: #e5e7eb;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
    }

    .admin-frame {
      width: 100%;
      max-width: 1260px;
      border-radius: 28px;
      background: radial-gradient(circle at top left, #020617 0%, #020617 52%, #020617 100%);
      box-shadow:
        0 32px 80px rgba(0,0,0,0.7),
        0 0 0 1px rgba(15,23,42,0.9);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .frame-header {
      padding: 18px 28px 12px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .frame-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 18px;
      background:
        radial-gradient(circle at 20% 10%, #fefce8 0%, #facc15 25%, #b45309 80%);
      box-shadow: 0 10px 25px rgba(180,83,9,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #030712;
      font-weight: 800;
      font-size: 22px;
    }
    .brand-text-title {
      font-size: 17px;
      font-weight: 600;
      color: #f9fafb;
    }
    .brand-text-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 3px;
    }
    .badge-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .pill {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #e5e7eb;
      background: radial-gradient(circle at top, rgba(31,41,55,0.9), rgba(15,23,42,0.95));
    }
    .pill.gold {
      border-color: rgba(245,158,11,0.55);
      color: #fbbf24;
      background: radial-gradient(circle at 0 0, rgba(254,249,195,0.08), #020617);
    }
    .frame-header-right {
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #6b7280;
    }

    .frame-body {
      flex: 1;
      display: grid;
      grid-template-columns: 290px minmax(0, 1fr) 280px;
      gap: 16px;
      padding: 18px 22px 22px;
    }

    /* 左栏：环境 + 概览 + 最近 5 个用户 */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      background: radial-gradient(circle at top left, #020617 0%, #020617 52%, #020617 100%);
      border-radius: 20px;
      border: 1px solid rgba(31,41,55,0.95);
      box-shadow: 0 14px 35px rgba(0,0,0,0.65);
      padding: 14px 16px 12px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
    }
    .card-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }
    .env-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 10px;
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }
    .label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .pill-small {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
    }
    .pill-small.green {
      border-color: rgba(22,163,74,0.8);
      color: #bbf7d0;
      background: radial-gradient(circle at 0 0, rgba(34,197,94,0.15), #022c22);
    }
    .pill-small.gold {
      border-color: rgba(245,158,11,0.8);
      color: #fde68a;
      background: radial-gradient(circle at 0 0, rgba(245,158,11,0.18), #1f2937);
    }

    .overview-stat {
      display: grid;
      grid-template-columns: 1.4fr 1.6fr;
      gap: 8px;
      font-size: 11px;
      margin-top: 2px;
    }
    .overview-stat-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .overview-value {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }

    .btn-danger {
      margin-top: 10px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 8px 0;
      font-size: 12px;
      font-weight: 500;
      background: radial-gradient(circle at 0 0, rgba(239,68,68,0.25), #111827);
      color: #fecaca;
      cursor: pointer;
      border: 1px solid rgba(248,113,113,0.65);
    }
    .btn-danger:hover {
      background: radial-gradient(circle at 0 0, rgba(220,38,38,0.3), #020617);
    }

    .small-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    .small-list {
      font-size: 11px;
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), #020617);
      overflow: hidden;
    }
    .small-list-row {
      display: grid;
      grid-template-columns: 1.7fr 0.7fr;
      padding: 4px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }
    .small-list-row:last-child { border-bottom: none; }
    .small-email {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 中间主区域 */
    .main {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .tabs-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .tabs {
      display: inline-flex;
      gap: 4px;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }
    .tab {
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 11px;
      cursor: pointer;
      color: #9ca3af;
      border: none;
      background: transparent;
    }
    .tab.active {
      background: radial-gradient(circle at top, rgba(59,130,246,0.45), #020617);
      color: #e5f0ff;
    }

    .refresh-btn {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at 0 0, rgba(59,130,246,0.15), #020617);
      font-size: 11px;
      color: #bfdbfe;
      padding: 4px 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .summary-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    .summary-card {
      border-radius: 18px;
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top left, #020617 0%, #020617 55%, #020617 100%);
      padding: 10px 12px 8px;
      font-size: 11px;
      color: #9ca3af;
    }
    .summary-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .summary-main {
      font-size: 18px;
      font-weight: 600;
      color: #f9fafb;
      margin-bottom: 2px;
    }
    .summary-note { font-size: 11px; }

    .charts-row {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.1fr);
      gap: 10px;
      margin-top: 4px;
    }
    .chart-card {
      border-radius: 18px;
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top left, #020617 0%, #020617 60%, #020617 100%);
      padding: 10px 12px 10px;
    }
    .chart-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #6b7280;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chart-sub { font-size: 10px; color: #9ca3af; }

    canvas { width: 100%; height: 170px; display: block; }

    .table-card {
      border-radius: 18px;
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top left, #020617 0%, #020617 60%, #020617 100%);
      padding: 10px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .table-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .table-meta {
      font-size: 11px;
      color: #9ca3af;
    }
    .table-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .search-input {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 5px 10px;
      font-size: 11px;
      color: #e5e7eb;
      min-width: 170px;
    }
    .search-input::placeholder { color: #6b7280; }
    .select {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 4px 9px;
      font-size: 11px;
      color: #e5e7eb;
    }
    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      color: #e5e7eb;
      padding: 4px 10px;
      cursor: pointer;
    }
    .btn-gold {
      border-radius: 999px;
      border: 1px solid rgba(245,158,11,0.7);
      background: radial-gradient(circle at 0 0, rgba(251,191,36,0.22), #111827);
      font-size: 11px;
      color: #fed7aa;
      padding: 4px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .table-wrapper {
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead {
      background: rgba(17,24,39,0.98);
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      white-space: nowrap;
    }
    th {
      text-align: left;
      font-weight: 500;
      color: #9ca3af;
      font-size: 11px;
    }
    tbody tr {
      cursor: pointer;
    }
    tbody tr:hover {
      background: radial-gradient(circle at 0 0, rgba(59,130,246,0.18), rgba(15,23,42,0.95));
    }

    .plan-pill {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 2px 8px;
      font-size: 10px;
      text-transform: uppercase;
    }

    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
      padding-top: 4px;
    }
    .pagination {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .page-btn {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      color: #e5e7eb;
      padding: 3px 9px;
      cursor: pointer;
    }
    .page-btn[disabled] {
      opacity: .35;
      cursor: default;
    }

    /* 右侧详情面板 */
    .detail-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .detail-card {
      border-radius: 18px;
      border: 1px solid rgba(31,41,55,0.95);
      background: radial-gradient(circle at top left, #020617 0%, #020617 55%, #020617 100%);
      padding: 10px 12px 10px;
      font-size: 11px;
      color: #9ca3af;
    }
    .detail-title {
      font-size: 12px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 4px;
    }
    .detail-label {
      font-size: 10px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-top: 6px;
      margin-bottom: 2px;
    }
    .detail-value {
      font-size: 11px;
      color: #e5e7eb;
      word-break: break-all;
    }

    .muted {
      color: #6b7280;
      font-size: 10px;
      margin-top: 4px;
    }

    /* 登录遮罩 */
    .login-overlay {
      position: fixed;
      inset: 0;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(3,7,18,0.98));
      backdrop-filter: blur(18px);
    }
    .login-card {
      width: 100%;
      max-width: 440px;
      border-radius: 24px;
      padding: 26px 26px 20px;
      background: radial-gradient(circle at top left, #020617 0%, #020617 55%, #020617 100%);
      box-shadow:
        0 30px 80px rgba(0,0,0,0.85),
        0 0 0 1px rgba(31,41,55,0.9);
    }
    .login-title {
      font-size: 18px;
      font-weight: 600;
      color: #f9fafb;
      margin-bottom: 4px;
    }
    .login-desc {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .login-input {
      width: 100%;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      margin-bottom: 12px;
    }
    .login-input::placeholder { color: #6b7280; }
    .login-btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 9px 0;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at 0 0, #fde68a, #f97316);
      box-shadow: 0 18px 45px rgba(251,146,60,0.8);
      color: #111827;
      margin-bottom: 8px;
    }
    .login-btn:disabled {
      opacity: 0.7;
      cursor: progress;
      box-shadow: none;
    }
    .login-error {
      font-size: 11px;
      color: #fecaca;
      min-height: 16px;
      margin-top: 4px;
    }
    .login-hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
      line-height: 1.5;
    }

    @media (max-width: 1100px) {
      .frame-body {
        grid-template-columns: 100%;
        grid-template-rows: auto auto auto;
      }
      .detail-panel {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .frame-header { padding: 14px 14px 10px; }
      .frame-body { padding: 14px; }
      .summary-row { grid-template-columns: 1fr; }
      .charts-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- 登录遮罩 -->
  <div id="admin-login" class="login-overlay">
    <div class="login-card">
      <div class="badge-row" style="margin-bottom: 8px;">
        <span class="pill gold">AURUM ADMIN</span>
        <span class="pill">INTERNAL DESK</span>
      </div>
      <div class="login-title">Aurum Task Desk 后台</div>
      <div class="login-desc">
        输入你的管理员密码登录，然后查看注册用户数据、趋势和内部统计。
      </div>

      <form id="adminLoginForm">
        <input
          id="adminPasswordInput"
          class="login-input"
          type="password"
          autocomplete="current-password"
          placeholder="Admin password"
        />
        <button id="adminLoginButton" class="login-btn" type="submit">
          进入 Aurum Admin 控制台
        </button>
      </form>

      <div id="adminLoginError" class="login-error"></div>

      <div class="login-hint">
        提示：管理员密码保存在 Cloudflare Worker 的 <span style="color:#facc15;">ADMIN_PASSWORD</span> 环境变量中。<br/>
        本页面只跑在「自己用的后台」，不会对外公开。
      </div>
    </div>
  </div>

  <!-- 主控制台 -->
  <div class="app-shell">
    <div class="admin-frame" id="admin-dashboard" style="opacity:0; pointer-events:none;">
      <div class="frame-header">
        <div class="frame-header-left">
          <div class="brand-icon">A</div>
          <div>
            <div class="brand-text-title">Aurum Task Desk 后台总览</div>
            <div class="brand-text-sub">
              重置注册趋势、套餐分布、访问日志，仅供内部使用。
            </div>
            <div class="badge-row">
              <span class="pill gold">AURUM ADMIN</span>
              <span class="pill">INTERNAL DESK</span>
            </div>
          </div>
        </div>
        <div class="frame-header-right">INTERNAL USE ONLY</div>
      </div>

      <div class="frame-body">
        <!-- 左栏 -->
        <div class="sidebar">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Environment</div>
                <div class="card-subtitle">运行环境与后端绑定。</div>
              </div>
            </div>
            <div class="env-grid">
              <div>
                <div class="label">Environment</div>
                <div class="pill-small green" id="envEnv">Production</div>
              </div>
              <div>
                <div class="label">Backend</div>
                <div class="pill-small gold" id="envBackend">Aurum Worker · D1 · AI</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Overview</div>
                <div class="card-subtitle">从 D1 数据库实时统计。</div>
              </div>
            </div>
            <div class="overview-stat">
              <div class="overview-stat-item">
                <div class="label">总用户数</div>
                <div class="overview-value" id="statTotal">-</div>
                <div class="card-subtitle">最近一位用户注册时间：</div>
                <div class="card-subtitle" id="statLastSignup">-</div>
              </div>
              <div class="overview-stat-item">
                <div class="label">最近 7 天新增</div>
                <div class="overview-value" id="statNew7d">-</div>
                <div class="card-subtitle">付费 / 免费用户</div>
                <div class="card-subtitle">
                  <span id="statPaidFree">-</span>
                </div>
              </div>
            </div>
            <button id="logoutButton" class="btn-danger">退出后台</button>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">最近 5 个注册用户</div>
            </div>
            <div class="small-list-header">
              <span>最近注册</span>
              <span id="recent5Meta">-</span>
            </div>
            <div id="recent5List" class="small-list">
              <!-- rows -->
            </div>
            <div class="muted">
              按注册时间倒序，仅展示最近 5 个用户。
            </div>
          </div>
        </div>

        <!-- 中间主区域 -->
        <div class="main">
          <div class="tabs-row">
            <div class="tabs">
              <button class="tab active">用户概览</button>
              <button class="tab" disabled style="opacity:.35; cursor:not-allowed;">
                访问日志（下个版本）
              </button>
            </div>
            <button id="refreshButton" class="refresh-btn">
              刷新数据
            </button>
          </div>

          <div class="summary-row">
            <div class="summary-card">
              <div class="summary-title">总用户数</div>
              <div class="summary-main" id="summaryTotal">-</div>
              <div class="summary-note" id="summaryFirstSignup">最近一位注册时间：-</div>
            </div>
            <div class="summary-card">
              <div class="summary-title">最近 7 天新增</div>
              <div class="summary-main" id="summaryNew7d">-</div>
              <div class="summary-note">
                按注册时间过滤，用于观察投放效果。
              </div>
            </div>
            <div class="summary-card">
              <div class="summary-title">套餐分布（当前用户）</div>
              <div class="summary-main" id="summaryPlans">free × -</div>
              <div class="summary-note">
                未来接入 Paddle / Stripe 后，免费 / 付费结构一目了然。
              </div>
            </div>
          </div>

          <div class="charts-row">
            <div class="chart-card">
              <div class="chart-title">
                <span>最近 14 天注册趋势</span>
                <span class="chart-sub" id="trendRange">—</span>
              </div>
              <canvas id="signupChart"></canvas>
            </div>
            <div class="chart-card">
              <div class="chart-title">
                <span>套餐分布（当前页面数据）</span>
                <span class="chart-sub" id="donutMeta">free / paid</span>
              </div>
              <canvas id="planDonut"></canvas>
            </div>
          </div>

          <div class="table-card">
            <div class="table-top-bar">
              <div class="table-meta" id="tableMeta">
                最近注册用户（支持搜索 + 分页），当前第 1 页。
              </div>
              <div class="table-controls">
                <input
                  id="searchInput"
                  class="search-input"
                  type="text"
                  placeholder="搜索 email / IP / 国家 / 来源"
                />
                <select id="pageSizeSelect" class="select">
                  <option value="25">每页 25 条</option>
                  <option value="50" selected>每页 50 条</option>
                  <option value="100">每页 100 条</option>
                </select>
                <button id="exportButton" class="btn-gold">
                  导出 CSV
                </button>
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th style="width:52px;">ID</th>
                    <th>Email</th>
                    <th style="width:70px;">Plan</th>
                    <th style="width:110px;">IP</th>
                    <th style="width:80px;">国家</th>
                    <th style="width:105px;">来源</th>
                    <th style="width:150px;">创建时间</th>
                  </tr>
                </thead>
                <tbody id="usersTbody">
                  <!-- rows -->
                </tbody>
              </table>
            </div>

            <div class="table-footer">
              <div id="tableInfo">第 0 条，共 0 条。</div>
              <div class="pagination">
                <button id="prevPage" class="page-btn">上一页</button>
                <span id="pageIndicator">第 1 / 1 页</span>
                <button id="nextPage" class="page-btn">下一页</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 右侧详情 -->
        <div class="detail-panel">
          <div class="detail-card">
            <div class="detail-title">选中用户详情</div>
            <div class="muted" id="detailEmpty">
              点击下方表格中的任意一行，可以在这里查看用户的 IP、国家、来源等信息。
            </div>

            <div id="detailContent" style="display:none;">
              <div class="detail-label">Email</div>
              <div class="detail-value" id="detailEmail"></div>

              <div class="detail-label">Plan</div>
              <div class="detail-value" id="detailPlan"></div>

              <div class="detail-label">IP 地址</div>
              <div class="detail-value" id="detailIp"></div>

              <div class="detail-label">国家 / 地区</div>
              <div class="detail-value" id="detailCountry"></div>

              <div class="detail-label">注册来源</div>
              <div class="detail-value" id="detailSource"></div>

              <div class="detail-label">创建时间</div>
              <div class="detail-value" id="detailCreated"></div>

              <div class="detail-label">User-Agent</div>
              <div class="detail-value" id="detailUa"></div>

              <div class="muted" style="margin-top:8px;">
                后端字段来自 D1 表 <code>aurum_users.users</code>，用于高价值用户筛选与风控追踪。
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 根据你现在的 Worker 地址
    const API_BASE = "https://aurum-task-worker.sophieinbg.workers.dev";

    let adminPassword = "";
    let allUsers = [];
    let currentPage = 1;
    let pageSize = 50;
    let currentSearch = "";

    const loginOverlay = document.getElementById("admin-login");
    const dashboard = document.getElementById("admin-dashboard");
    const loginForm = document.getElementById("adminLoginForm");
    const loginInput = document.getElementById("adminPasswordInput");
    const loginBtn = document.getElementById("adminLoginButton");
    const loginErr = document.getElementById("adminLoginError");

    const summaryTotal = document.getElementById("summaryTotal");
    const summaryFirstSignup = document.getElementById("summaryFirstSignup");
    const summaryNew7d = document.getElementById("summaryNew7d");
    const summaryPlans = document.getElementById("summaryPlans");

    const statTotal = document.getElementById("statTotal");
    const statLastSignup = document.getElementById("statLastSignup");
    const statNew7d = document.getElementById("statNew7d");
    const statPaidFree = document.getElementById("statPaidFree");

    const recent5List = document.getElementById("recent5List");
    const recent5Meta = document.getElementById("recent5Meta");

    const signupCanvas = document.getElementById("signupChart");
    const donutCanvas = document.getElementById("planDonut");
    const trendRange = document.getElementById("trendRange");
    const donutMeta = document.getElementById("donutMeta");

    const usersTbody = document.getElementById("usersTbody");
    const tableMeta = document.getElementById("tableMeta");
    const tableInfo = document.getElementById("tableInfo");
    const pageIndicator = document.getElementById("pageIndicator");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const searchInput = document.getElementById("searchInput");
    const pageSizeSelect = document.getElementById("pageSizeSelect");
    const exportButton = document.getElementById("exportButton");
    const refreshButton = document.getElementById("refreshButton");
    const logoutButton = document.getElementById("logoutButton");

    // 详情面板
    const detailEmpty = document.getElementById("detailEmpty");
    const detailContent = document.getElementById("detailContent");
    const detailEmail = document.getElementById("detailEmail");
    const detailPlan = document.getElementById("detailPlan");
    const detailIp = document.getElementById("detailIp");
    const detailCountry = document.getElementById("detailCountry");
    const detailSource = document.getElementById("detailSource");
    const detailCreated = document.getElementById("detailCreated");
    const detailUa = document.getElementById("detailUa");

    function formatDateTime(ts) {
      if (!ts) return "-";
      const d = new Date(ts * 1000);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${y}/${m}/${day} ${hh}:${mm}:${ss}`;
    }

    function formatDate(ts) {
      if (!ts) return "";
      const d = new Date(ts * 1000);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function computeStats() {
      const total = allUsers.length;
      const now = Date.now() / 1000;
      const sevenDaysAgo = now - 7 * 24 * 3600;

      const sorted = [...allUsers].sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
      const last = sorted[0];

      const new7d = allUsers.filter(u => (u.created_at || 0) >= sevenDaysAgo).length;

      let freeCount = 0;
      let paidCount = 0;
      for (const u of allUsers) {
        const p = (u.plan || "free").toLowerCase();
        if (p === "free") freeCount++;
        else paidCount++;
      }

      return {
        total,
        lastSignup: last ? formatDateTime(last.created_at) : "-",
        new7d,
        freeCount,
        paidCount,
        latestCreatedAt: last ? last.created_at : 0,
      };
    }

    function updateOverview() {
      const s = computeStats();
      summaryTotal.textContent = s.total || "-";
      statTotal.textContent = s.total || "-";

      summaryFirstSignup.textContent = s.lastSignup || "-";
      statLastSignup.textContent = s.lastSignup || "-";

      summaryNew7d.textContent = s.new7d || 0;
      statNew7d.textContent = s.new7d || 0;

      const planText = `free × ${s.freeCount} / paid × ${s.paidCount}`;
      summaryPlans.textContent = planText;
      statPaidFree.textContent = planText;

      if (allUsers.length) {
        const sorted = [...allUsers].sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
        const last5 = sorted.slice(0, 5);
        recent5Meta.textContent = `共 ${allUsers.length} 个用户`;
        recent5List.innerHTML = last5
          .map(u => {
            const email = u.email || "";
            const plan = (u.plan || "free").toUpperCase();
            return `
              <div class="small-list-row">
                <div class="small-email">${email}</div>
                <div style="text-align:right;">${plan}</div>
              </div>
            `;
          })
          .join("");
      } else {
        recent5Meta.textContent = "暂无用户";
        recent5List.innerHTML = `
          <div class="small-list-row">
            <div class="small-email">No users yet</div>
            <div style="text-align:right;">-</div>
          </div>
        `;
      }
    }

    // 简单画线图
    function drawLine(ctx, points, labels) {
      const w = ctx.canvas.width;
      const h = ctx.canvas.height;
      ctx.clearRect(0, 0, w, h);
      ctx.save();
      ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);

      ctx.fillStyle = "#020617";
      ctx.fillRect(0, 0, w, h);

      if (!points.length) {
        ctx.fillStyle = "#6b7280";
        ctx.font = "11px -apple-system, system-ui";
        ctx.fillText("暂无数据", 12, h / 2);
        ctx.restore();
        return;
      }

      const paddingLeft = 32;
      const paddingRight = 14;
      const paddingTop = 18;
      const paddingBottom = 26;

      const maxV = Math.max(...points);
      const minV = 0;
      const plotW = w - paddingLeft - paddingRight;
      const plotH = h - paddingTop - paddingBottom;

      ctx.strokeStyle = "rgba(55,65,81,0.9)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, paddingTop);
      ctx.lineTo(paddingLeft, paddingTop + plotH);
      ctx.lineTo(paddingLeft + plotW, paddingTop + plotH);
      ctx.stroke();

      // y 轴刻度
      ctx.fillStyle = "#6b7280";
      ctx.font = "10px -apple-system, system-ui";
      const yMax = maxV || 1;
      for (let i = 0; i <= 3; i++) {
        const v = Math.round((yMax * i) / 3);
        const y =
          paddingTop + plotH - (plotH * v) / (yMax || 1);
        ctx.fillText(String(v), 4, y + 3);
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(paddingLeft + plotW, y);
        ctx.strokeStyle = "rgba(31,41,55,0.6)";
        ctx.stroke();
      }

      // 线条
      ctx.beginPath();
      const stepX = plotW / Math.max(points.length - 1, 1);
      for (let i = 0; i < points.length; i++) {
        const x = paddingLeft + stepX * i;
        const y =
          paddingTop +
          plotH -
          (plotH * (points[i] - minV)) / (yMax - minV || 1);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "#60a5fa";
      ctx.lineWidth = 2;
      ctx.stroke();

      // 点
      ctx.fillStyle = "#bfdbfe";
      for (let i = 0; i < points.length; i++) {
        const x = paddingLeft + stepX * i;
        const y =
          paddingTop +
          plotH -
          (plotH * (points[i] - minV)) / (yMax - minV || 1);
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();
      }

      // x 轴标签（最多 6 个）
      const labelStep = Math.ceil(labels.length / 6) || 1;
      for (let i = 0; i < labels.length; i += labelStep) {
        const x = paddingLeft + stepX * i;
        const y = paddingTop + plotH + 14;
        ctx.fillStyle = "#6b7280";
        ctx.font = "9px -apple-system, system-ui";
        ctx.fillText(labels[i].slice(5), x - 16, y + 4);
      }

      ctx.restore();
    }

    function drawDonut(ctx, freeCount, paidCount) {
      const w = ctx.canvas.width;
      const h = ctx.canvas.height;
      ctx.clearRect(0, 0, w, h);
      ctx.save();
      ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);

      ctx.fillStyle = "#020617";
      ctx.fillRect(0, 0, w, h);

      const total = freeCount + paidCount;
      if (!total) {
        ctx.fillStyle = "#6b7280";
        ctx.font = "11px -apple-system, system-ui";
        ctx.fillText("暂无数据", 12, h / 2);
        ctx.restore();
        return;
      }

      // 稍微往左移 + 缩小半径，避免被切边
      const cx = w / 2 - 10;
      const cy = h / 2;
      const r = Math.min(w, h) / 2 - 24;
      const innerR = r * 0.6;

      const freeAngle = (freeCount / total) * Math.PI * 2;
      const paidAngle = (paidCount / total) * Math.PI * 2;

      // free
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r, 0, freeAngle, false);
      ctx.closePath();
      ctx.fillStyle = "#60a5fa";
      ctx.fill();

      // paid
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r, freeAngle, freeAngle + paidAngle, false);
      ctx.closePath();
      ctx.fillStyle = "#f97316";
      ctx.fill();

      // 内圈
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(cx, cy, innerR, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalCompositeOperation = "source-over";

      // 文本
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "12px -apple-system, system-ui";
      ctx.textAlign = "center";
      ctx.fillText(`${total}`, cx, cy + 4);
      ctx.font = "10px -apple-system, system-ui";
      ctx.fillStyle = "#9ca3af";
      ctx.fillText("用户数", cx, cy + 18);

      ctx.restore();
    }

    function updateCharts() {
      // 趋势图：最近 14 天
      const now = Date.now() / 1000;
      const fourteenAgo = now - 13 * 24 * 3600;

      const dayMap = new Map();
      for (let i = 0; i < 14; i++) {
        const ts = fourteenAgo + i * 24 * 3600;
        const dStr = formatDate(ts);
        dayMap.set(dStr, 0);
      }
      for (const u of allUsers) {
        if (!u.created_at) continue;
        if (u.created_at < fourteenAgo) continue;
        const dStr = formatDate(u.created_at);
        if (dayMap.has(dStr)) {
          dayMap.set(dStr, dayMap.get(dStr) + 1);
        }
      }
      const labels = Array.from(dayMap.keys());
      const points = Array.from(dayMap.values());
      const ctxLine = signupCanvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      signupCanvas.width = signupCanvas.clientWidth * dpr;
      signupCanvas.height = signupCanvas.clientHeight * dpr;
      drawLine(ctxLine, points, labels);

      if (labels.length) {
        trendRange.textContent = `${labels[0]} ~ ${labels[labels.length - 1]}`;
      } else {
        trendRange.textContent = "最近 14 天暂无注册";
      }

      // 圆环图：当前页面的数据分布
      const filtered = getFilteredUsers();
      const pageUsers = getPageUsers(filtered);
      let freeCount = 0;
      let paidCount = 0;
      for (const u of pageUsers) {
        const p = (u.plan || "free").toLowerCase();
        if (p === "free") freeCount++;
        else paidCount++;
      }
      donutMeta.textContent = `当前页：free × ${freeCount} / paid × ${paidCount}`;
      const ctxDonut = donutCanvas.getContext("2d");
      donutCanvas.width = donutCanvas.clientWidth * dpr;
      donutCanvas.height = donutCanvas.clientHeight * dpr;
      drawDonut(ctxDonut, freeCount, paidCount);
    }

    function getFilteredUsers() {
      if (!currentSearch) return allUsers;
      const q = currentSearch.toLowerCase();
      return allUsers.filter(u => {
        const text =
          (u.email || "") +
          " " +
          (u.ip || "") +
          " " +
          (u.country || "") +
          " " +
          (u.signup_source || "");
        return text.toLowerCase().includes(q);
      });
    }

    function getPageUsers(filtered) {
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const start = (currentPage - 1) * pageSize;
      return filtered.slice(start, start + pageSize);
    }

    function renderTable() {
      const filtered = getFilteredUsers();
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const pageUsers = getPageUsers(filtered);

      usersTbody.innerHTML = pageUsers
        .map(u => {
          const plan = (u.plan || "free").toUpperCase();
          const ip = u.ip || "-";
          const country = u.country || "-";
          const source = u.signup_source || "-";
          const created = formatDateTime(u.created_at);
          return `
            <tr data-id="${u.id}">
              <td>${u.id}</td>
              <td>${u.email || "-"}</td>
              <td><span class="plan-pill">${plan}</span></td>
              <td>${ip}</td>
              <td>${country}</td>
              <td>${source}</td>
              <td>${created}</td>
            </tr>
          `;
        })
        .join("");

      const startIndex = total ? (currentPage - 1) * pageSize + 1 : 0;
      const endIndex = total ? Math.min(currentPage * pageSize, total) : 0;

      tableInfo.textContent = `第 ${startIndex}–${endIndex} 条，共 ${total} 条。`;
      pageIndicator.textContent = `第 ${currentPage} / ${totalPages} 页`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;

      tableMeta.textContent = `最近注册用户（支持搜索 + 分页），当前第 ${currentPage} 页，按注册时间倒序。`;

      // 绑定行点击
      for (const tr of usersTbody.querySelectorAll("tr")) {
        tr.addEventListener("click", () => {
          const id = Number(tr.getAttribute("data-id"));
          const user = allUsers.find(u => u.id === id);
          if (user) showUserDetail(user);
        });
      }
    }

    function showUserDetail(user) {
      detailEmpty.style.display = "none";
      detailContent.style.display = "block";

      detailEmail.textContent = user.email || "-";
      detailPlan.textContent = (user.plan || "free").toUpperCase();
      detailIp.textContent = user.ip || "-";
      detailCountry.textContent = user.country || "-";
      detailSource.textContent = user.signup_source || "-";
      detailCreated.textContent = formatDateTime(user.created_at);
      detailUa.textContent = user.user_agent || "-";
    }

    async function fetchUsers() {
      try {
        refreshButton.textContent = "刷新中…";
        refreshButton.disabled = true;

        const res = await fetch(`${API_BASE}/admin/users`, {
          method: "GET",
          headers: {
            "x-admin-password": adminPassword,
          },
        });

        if (!res.ok) {
          throw new Error("获取用户数据失败：" + res.status);
        }

        const data = await res.json();
        allUsers = Array.isArray(data.users) ? data.users : [];
        currentPage = 1;
        updateOverview();
        renderTable();
        updateCharts();
      } catch (err) {
        console.error(err);
        alert("拉取后台用户数据失败，请稍后重试。");
      } finally {
        refreshButton.textContent = "刷新数据";
        refreshButton.disabled = false;
      }
    }

    function exportCSVFile() {
      const filtered = getFilteredUsers();
      if (!filtered.length) {
        alert("当前没有可导出的数据。");
        return;
      }

      const header = ["id", "email", "plan", "ip", "country", "signup_source", "created_at", "user_agent"];
      const rows = [header.join(",")];

      for (const u of filtered) {
        const row = [
          u.id,
          '"' + (u.email || "").replace(/"/g, '""') + '"',
          (u.plan || "free"),
          '"' + (u.ip || "").replace(/"/g, '""') + '"',
          '"' + (u.country || "").replace(/"/g, '""') + '"',
          '"' + (u.signup_source || "").replace(/"/g, '""') + '"',
          formatDateTime(u.created_at),
          '"' + (u.user_agent || "").replace(/"/g, '""') + '"',
        ];
        rows.push(row.join(","));
      }

      const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const now = new Date();
      const name = `aurum_users_${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}.csv`;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 登录逻辑
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const pwd = loginInput.value.trim();
      if (!pwd) {
        loginErr.textContent = "请输入管理员密码。";
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = "验证中…";
      loginErr.textContent = "";

      try {
        const res = await fetch(`${API_BASE}/admin/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pwd }),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          loginErr.textContent = data.error || "登录失败，请检查密码。";
          loginBtn.disabled = false;
          loginBtn.textContent = "进入 Aurum Admin 控制台";
          return;
        }

        adminPassword = pwd;
        loginOverlay.style.display = "none";
        dashboard.style.opacity = "1";
        dashboard.style.pointerEvents = "auto";

        await fetchUsers();
      } catch (err) {
        console.error(err);
        loginErr.textContent = "网络异常，请确认 Worker 是否在线。";
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = "进入 Aurum Admin 控制台";
      }
    });

    refreshButton.addEventListener("click", fetchUsers);

    logoutButton.addEventListener("click", () => {
      adminPassword = "";
      allUsers = [];
      usersTbody.innerHTML = "";
      detailEmpty.style.display = "block";
      detailContent.style.display = "none";
      loginInput.value = "";
      loginErr.textContent = "";
      loginOverlay.style.display = "flex";
      dashboard.style.opacity = "0";
      dashboard.style.pointerEvents = "none";
    });

    searchInput.addEventListener("input", (e) => {
      currentSearch = e.target.value.trim();
      currentPage = 1;
      renderTable();
      updateCharts();
    });

    pageSizeSelect.addEventListener("change", (e) => {
      pageSize = Number(e.target.value) || 50;
      currentPage = 1;
      renderTable();
      updateCharts();
    });

    prevPageBtn.addEventListener("click", () => {
      currentPage--;
      renderTable();
      updateCharts();
    });
    nextPageBtn.addEventListener("click", () => {
      currentPage++;
      renderTable();
      updateCharts();
    });

    exportButton.addEventListener("click", exportCSVFile);
  </script>
</body>
</html>
